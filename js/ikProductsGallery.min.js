var ikProductsImageGalleryDefault={draggable:!0,popupIndent:{top:220,left:160,right:160,bottom:0},galleyWrapperIdAttribute:"data-gallery-id",imageQuerySelector:"img",imageWrapperClass:"ikPGallery-image-wr",imageIdAttribute:"data-id",addProductPopup:".add-product-popup",addProductForm:".add-product-form",closePopupBtn:".ikProductsGallery-close-btn",savePointsButton:".save-all-points",pointTemplate:".point-element",getPointsUrl:"getPoints.php",savePointsUrl:"savePoints.php",selectTypeIcon:'[name="point_icon"]',typeIconDefault:"pin_red.svg",imagesUrl:"images/",addProductFormOnSubmit:function(e,t,o,i){}};if(void 0===ikExtend||"function"!=typeof ikExtend)var ikExtend=function(e,t){var o,i={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(i[o]=e[o]);for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(i[o]=t[o]);return i};var _ikProductsImageGallery=function(e,t){this.element=e,this.settings=t,this.galleryId=e.getAttribute(this.settings.galleyWrapperIdAttribute),this.imagesElements=this.element.querySelectorAll(this.settings.imageQuerySelector),this.images={},this._init()};_ikProductsImageGallery.prototype._init=function(){this._addClass(this.element,this._is_touch_device()?"is-touch-device":"is-not-touch-device"),this._initPoints(),this._savePoints(),this._onResize()},_ikProductsImageGallery.prototype._initPoints=function(){var e=this,t=[];try{if(e.imagesElements.length>0)for(var o=0;o<e.imagesElements.length;o++){var i=e.imagesElements[o],r=i.getAttribute(e.settings.imageIdAttribute);e._wrap(i,"div",{class:e.settings.imageWrapperClass,"data-image-id":r}),e.images[r]={id:r,points:[]},i.addEventListener("click",function(t){t.preventDefault();var o=this.parentNode.querySelectorAll(".ikPGallery-point.is-touched");if(0===o.length)e._addPopup(this,e._getImageXY(t));else for(var i=0;i<o.length;i++)e._removeClass(o[i],"is-touched")}),t.push(r)}else console.log("Not found images selector: "+this.settings.imageQuerySelector);e._http("POST",e.settings.getPointsUrl+"?id="+e.galleryId,{images:t},function(){try{this.response&&e._setPoints(JSON.parse(this.response))}catch(e){throw e}})}catch(e){throw e}},_ikProductsImageGallery.prototype._setPoints=function(e){var t=this;if(t.images)for(var o in e)if(o in t.images){t.images[o].points=e[o].points;for(var i in t.images[o].points)t._addPoint(o,t.images[o].points[i])}},_ikProductsImageGallery.prototype._addPoint=function(e,t){var o=this,i=document.createElement("div"),r=o.element.querySelectorAll(o.settings.imageQuerySelector+"["+o.settings.imageIdAttribute+'="'+e+'"]')[0].parentNode;i.setAttribute("class","ikPGallery-point"),i.style.top=t.position.y,i.style.left=t.position.x,i.innerHTML='<div class="ikPGallery-point-pin"><img src="'+o.settings.imagesUrl+t.point_icon+'" alt=""></div><div class="ikPGallery-point-popup">'+document.querySelectorAll(o.settings.pointTemplate)[0].innerHTML+"</div>";for(var a in t){var s=i.querySelectorAll('[data-bind-value="'+a+'"]');if(s.length>0)for(var n=0;n<s.length;n++)s[n].innerHTML=t[a]}r.appendChild(i),o.settings.draggable&&o._draggable(t,r,i),o._checkPopupPosition(r,i,t.position)},_ikProductsImageGallery.prototype._addPopup=function(e,t){var o=this,i=document.createElement("div"),r=document.createElement("div");i.setAttribute("class","ikPGallery-image-overlay"),r.setAttribute("class","ikPGallery-image-popup"),r.innerHTML=document.querySelectorAll(o.settings.addProductPopup)[0].innerHTML,e.parentNode.appendChild(i),e.parentNode.appendChild(r);var a=r.querySelectorAll(o.settings.addProductForm)[0],s=r.querySelectorAll(o.settings.closePopupBtn)[0];a.onsubmit=function(s){s.preventDefault();for(var n=o._serialize(a),l=e.getAttribute(o.settings.imageIdAttribute),p=o.element.querySelectorAll(o.settings.selectTypeIcon),c=0;c<p.length;c++){if(1==p[c].checked){n.point_icon=p[c].value;break}n.point_icon=o.settings.typeIconDefault}n.position=t,o.images[l].points.push(n),o._removePopup(i,r),o._addPoint(l,n),o.settings.addProductFormOnSubmit(a,o,e,n)},i.addEventListener("click",function(){o._removePopup(i,r)}),s.addEventListener("click",function(){o._removePopup(i,r)})},_ikProductsImageGallery.prototype._removePopup=function(e,t){e.parentNode.removeChild(e),t.parentNode.removeChild(t)},_ikProductsImageGallery.prototype._onResize=function(){var e=this;window.addEventListener("resize",function(){for(var t=0;t<e.imagesElements.length;t++)for(var o=e.imagesElements[t],i=o.parentNode.querySelectorAll(".ikPGallery-point"),r=0;r<i.length;r++){var a=i[r],s={x:parseFloat(a.style.left),y:parseFloat(a.style.top)};e._checkPopupPosition(o,a,s)}})},_ikProductsImageGallery.prototype._checkPopupPosition=function(e,t,o){var i=this,r=e.clientWidth,a=e.clientHeight,s=parseFloat(r*parseFloat(o.x)/100),n=parseFloat(a*parseFloat(o.y)/100);i._removeClass(t,"popup-y-top"),i._removeClass(t,"popup-y-bottom"),i._removeClass(t,"popup-x-left"),i._removeClass(t,"popup-x-center"),i._removeClass(t,"popup-x-right"),n<i.settings.popupIndent.top?i._addClass(t,"popup-y-bottom"):i._addClass(t,"popup-y-top"),s<i.settings.popupIndent.left?i._addClass(t,"popup-x-right"):s>r-i.settings.popupIndent.right?i._addClass(t,"popup-x-left"):i._addClass(t,"popup-x-center")},_ikProductsImageGallery.prototype._draggable=function(e,t,o){var i=this,r=e.position,a=t.querySelectorAll(i.settings.imageQuerySelector)[0];o.querySelectorAll(".ikPGallery-point-pin")[0].onmousedown=function(t){r=e.position,i._addClass(o,"dragged"),i._addClass(a,"dragged"),a.onmousemove=function(e){var t=i._getImageXY(e);r=t,o.style.top=t.y,o.style.left=t.x,i._checkPopupPosition(a,o,r)},document.onmouseup=function(t){a.onmousemove=null,e.position=r,i._checkPopupPosition(a,o,r),i._removeClass(o,"dragged"),i._removeClass(a,"dragged")}},o.querySelectorAll(".ikPGallery-point-pin")[0].addEventListener("touchstart",function(t){if(r=e.position,i._hasClass(o,"is-touched"))i._removeClass(o,"is-touched");else{var s=a.parentNode.querySelectorAll(".ikPGallery-point.is-touched");if(s.length>0)for(var n=0;n<s.length;n++)i._removeClass(s[n],"is-touched");i._addClass(o,"is-touched")}}),o.querySelectorAll(".ikPGallery-point-pin")[0].addEventListener("touchmove",function(e){e.preventDefault(),e.stopPropagation();var t=i._getTouchXY(e,a);r=t,o.style.top=t.y,o.style.left=t.x,i._addClass(o,"dragged"),i._removeClass(o,"is-touched"),i._addClass(a,"dragged")}),o.querySelectorAll(".ikPGallery-point-pin")[0].addEventListener("touchend",function(t){e.position=r,i._checkPopupPosition(a,o,r),i._removeClass(o,"dragged"),i._removeClass(a,"dragged")}),a.ondragstart=function(){return!1}},_ikProductsImageGallery.prototype._savePoints=function(){for(var e=this,t=e.element.querySelectorAll(e.settings.savePointsButton),o=0;o<t.length;o++)t[o].addEventListener("click",function(t){t.preventDefault(),e._http("POST",e.settings.savePointsUrl+"?id="+e.galleryId,e.images,function(){console.log("Zapisano!!!")})})},_ikProductsImageGallery.prototype._http=function(e,t,o,i){var r=new XMLHttpRequest;i=i||function(e){};r.open(e,t,!1),r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=i,r.send(JSON.stringify(o))},_ikProductsImageGallery.prototype._wrap=function(e,t,o){var i=document.createElement(t);for(var r in o)i.setAttribute(r,o[r]);e.parentNode.insertBefore(i,e),i.appendChild(e)},_ikProductsImageGallery.prototype._is_touch_device=function(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}},_ikProductsImageGallery.prototype._hasClass=function(e,t){return e.classList?e.classList.contains(t):!!e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))},_ikProductsImageGallery.prototype._addClass=function(e,t){e.classList?e.classList.add(t):this._hasClass(e,t)||(e.className+=" "+t)},_ikProductsImageGallery.prototype._removeClass=function(e,t){if(e.classList)e.classList.remove(t);else if(this._hasClass(e,t)){var o=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className=e.className.replace(o," ")}},_ikProductsImageGallery.prototype._getImageXY=function(e,t){var o={x:e.pageX-e.target.x,y:e.pageY-e.target.y};switch(t){case"number":return o;case"percent":default:return{x:parseFloat(100*o.x/e.target.clientWidth).toFixed(2)+"%",y:parseFloat(100*o.y/e.target.clientHeight).toFixed(2)+"%"}}},_ikProductsImageGallery.prototype._getTouchXY=function(e,t,o){var i=this._getOffset(t),r={x:e.changedTouches[0].pageX-i.left,y:e.changedTouches[0].pageY-i.top};switch(o){case"number":return r;case"percent":default:var a=parseFloat(100*r.x/t.clientWidth).toFixed(2),s=parseFloat(100*r.y/t.clientHeight).toFixed(2);return a<0?a=0:a>100&&(a=100),s<0?s=0:s>100&&(s=100),{x:a+"%",y:s+"%"}}},_ikProductsImageGallery.prototype._getOffset=function(e){var t=0,o=0;do{t+=e.offsetTop||0,o+=e.offsetLeft||0,e=e.offsetParent}while(e);return{top:t,left:o}},_ikProductsImageGallery.prototype._serialize=function(e){var t,o=e.querySelectorAll("input, select, textarea"),i={};for(t in o)o[t].tagName&&("checkbox"===o[t].type?i[o[t].name]=!0===o[t].checked&&o[t].value:i[o[t].name]=o[t].value);return i};var ikProductsImageGallery=function(e,t){try{var o=document.querySelectorAll(e);if(o.length>0)for(var i=0;i<o.length;i++)new _ikProductsImageGallery(o[i],ikExtend(ikProductsImageGalleryDefault,t))}catch(e){throw e}};new ikProductsImageGallery(".ikProductsGallery",{imageQuerySelector:"img.ikPGallery-image",addProductFormId:"add_product_popup"});